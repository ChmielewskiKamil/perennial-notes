@startuml PerennialArchitecture

left to right direction

skinparam linetype ortho
skinparam nodesep 50
skinparam ranksep 60

skinparam note {
    BorderColor black
    BackgroundColor white
    FontColor black
}
skinparam component {
    FontSize 20
}

skinparam collections {
    FontSize 20
}

'Invisible Placeholder'
skinparam artifact {
    BorderColor invisible
    BackgroundColor transparent
    FontSize 10
    FontColor transparent
}

/' Actors '/
actor Liquidators
actor Makers
actor Takers
actor "Market Operator" as MarketOperator
actor Admin

/' //////////////////////////////////////////////////////////////////
//                           Core Contracts                        //
////////////////////////////////////////////////////////////////// '/

collections Market

component Collateral {
    artifact Placeholder1
}

component MultiInvoker {
    artifact Placeholder2
}

component ChainlinkOracle {
    artifact Placeholder3
}

component Incentivizer {
    artifact Placeholder4
}

component Controller {
    artifact Placeholder5
}

component ProductProvider {
    artifact Placeholder6
}

/' //////////////////////////////////////////////////////////////////
//                       Contract Functions                        //
////////////////////////////////////////////////////////////////// '/

/'Collateral'/
rectangle deposit <<depositTo>>
rectangle withdrawFrom <<withdrawFrom>>
rectangle withdrawTo <<withdrawTo>>
rectangle liquidate <<liquidate>>
rectangle "Settle Account" as settleAccount <<settleAccount>>
rectangle "Settle Product" as settleProduct <<settleProduct>>
rectangle "Resolve Shortfall" as resolveShortfall <<resolveShortfall>>
rectangle "Claim Fees" as claimFee <<claimFee>>

/'Market'/
rectangle "Open Take Position" as openTake <<openTake>>
rectangle "Close Take Position" as closeTake <<closeTake>>
rectangle "Open Make Position" as openMake <<openMake>>
rectangle "Close Make Position" as closeMake <<closeMake>>
rectangle "Settle" as settle <<settle>>
rectangle "Close All Positions" as closeAll <<closeAll>>
rectangle "Close / Open Market" as updateClosed <<updateClosed>>
rectangle "Update Market Oracle" as updateOracle <<updateOracle>>

/' //////////////////////////////////////////////////////////////////
//                           Connections                           //
////////////////////////////////////////////////////////////////// '/

'Collateral contract functions'
deposit --> Collateral
withdrawTo --> Collateral
withdrawFrom --> Collateral
withdrawTo --> withdrawFrom
liquidate --> Collateral
settleAccount --> Collateral
settleProduct --> Collateral
claimFee --> Collateral
resolveShortfall --> Collateral
'Calls to Collateral contract functions'
Makers --> deposit
Makers --> withdrawTo
Makers --> withdrawFrom
Liquidators --> liquidate
Market --> settleAccount 
Market --> settleProduct 
MarketOperator --> resolveShortfall

'Market functions'
openMake --> Market
closeMake --> Market
openTake --> Market
closeTake --> Market
settle --> Market
closeAll --> Market
updateClosed --> Market
updateOracle --> Market
'Calls to Market contract functions'
Makers --> openMake 
Makers --> closeMake 
Takers --> openTake
Takers --> closeTake
Collateral --> closeAll
MarketOperator --> updateClosed
MarketOperator --> updateOracle

/' //////////////////////////////////////////////////////////////////
//                             Notes                               //
////////////////////////////////////////////////////////////////// '/

note bottom of settleAccount: Moves collateral within the product 
note top of settleProduct: Removes collateral\nfrom the product as fees
note right of MultiInvoker: Allows batch calls
note right of Market: In V1 known as Product
note left of Makers: Liquidity Providers
note left of Takers: Traders
note bottom of resolveShortfall: Market Operator or Insurer can re-capitalize insolvent market

footer Perennial Protocol Architecture | author: @kamilchmielu
@enduml
